## TCP 报文段的首部格式
一个 TCP 报文段分为首部和数据两部分。TCP 报文段首部的前20个字节是固定的，后面有4n字节是根据需要而增加的选项(n是整数)。因此 TCP 首部的最小长度是20字节
```sh
 0             1               2               3               4
 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
```

- 16位端口号（port number）：告知主机该报文段是来自哪里（源端口）以及传给哪个上层协议或应用程序（目的端口）的。进行TCP通信时，客户端通常使用系统自动选择的临时端口号，而服务器则需要自己指定端口号。
- 32位序号（sequence number）： —次TCP通信（从TCP连接建立到断开）过程中某一个传输方向上的字节流的毎个字节的编号。假设主机A和主机B进行TCP通信，A发送给B的第一个TCP报文段中，序号值被系统初始化为某个随机值ISN （Initial Sequence Number,初始序号值）。那么在该传输方向上（从A到B）,后续的TCP报文段中序号值将被系统设置成ISN加上该报文段所携带数据的第一个字节在整个字节流中的偏移。例如，某个TCP报文段传送的数据是字节流中的第1025〜2048字节，那么该报文段的序号值就是ISN+I025。另外一个传输方向(从B到A)的TCP报文段的序号值也具有相同的含义。
- 32位确认号(acknowledgement number):用作对另一方发送来的TCP报文段的响应. 其值是收到的TCP报文段的序号值加1.同时也是期望收到对方下一个报文段的第一个数据字节的序号。假设主机A和主机B进行TCP通信，那么A发送出的TCP报文段不仅携带自己的序号，而且包含对B发送来的TCP报文段的确认号。反之，B发送出的TCP报文段也同时携带自己的序号和对A发送来的报文段的确认号。若确认号为n，则证明到序号n-1为止的所有数据都已正确收到
- 数据偏移： 即头部长度(header length):标识该TCP头部有多少个32bit字(4字节)。因为4位最大能表示15,所以TCP头部最长是60字节。
- 下面有6个控制位
	- 紧急 URG(URGent)： 当 URG=1 时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)，而不是按原先的排队顺序来传送（作用于发送方(自己)）
	- 确认 ACK(ACKnowledgment) ：仅当 ACK=1 时确认号字段才有效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置1。ACK 也就是我们所熟悉的ack包，用来告诉对方上一个数据包已经成功收到。不过一般不会为了ack单独发送一个包，都是在下一个要发送的packet里设置ack位
	- PSH标志，表示接收方尽快交付接收应用进程，不要等到缓存填满再向上交付（作用于接收方（对方）），一般我们在http request的最后一个包里都能看到P位被设置
	- RST标志，表示要求对方重新建立连接。我们称携带RST标志的TCP报文段为复位 报文段	
	- SYN标志，表示请求建立一个连接。我们称携带SYN标志的TCP报文段为同步报文段
	- FIN标志，表示通知对方本端要关闭连接了.我们称携带FIN标志的TCP报文段为结束报文段
- 16位窗口大小(window size)：是TCP流量控制的一个手段。这里说的窗口，指的是接收窗口(Receiver Window, RWND)。它告诉对方本端的TCP接收缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度。
- 16位校验和(TCP checksum)：由发送端填充，接收端对TCP报文段执行CRC算法以检験TCP报文段在传输过程中是否损坏。注意，这个校验不仅包括TCP头部，也包括数据部分.这也是TCP可靠传输的一个重要保障。
- 16位紧急指针(urgent pointer):是一个正的偏移量。它和序号字段的值相加表示最后一个紧急数据的下一字节的序号。因此，确切地说，这个字段是紧急指针相对当前序号的偏移，不妨称之为紧急偏移。
- 选项 长度可变，最长可达40字节


## 网络连接状态详解
共有12中可能的状态，前面11种是按照TCP连接建立的三次握手和TCP连接断开的四次挥手过程来描述的：
- LISTEN：首先服务端需要打开一个socket进行监听，状态为 LISTEN，侦听来自远方TCP端口的连接请求 ；
- SYN_SENT：客户端通过应用程序调用connect进行active open，于是客户端tcp发送一个SYN以请求建立一个连接，之后状态置为 SYN_SENT，在发送连接请求后等待匹配的连接请求；
- SYN_RECV：服务端应发出ACK确认客户端的 SYN，同时自己向客户端发送一个SYN，之后状态置为，在收到和发送一个连接请求后等待对连接请求的确认；
- ESTABLISHED：代表一个打开的连接，双方可以进行或已经在数据交互了， 代表一个打开的连接，数据可以传送给用户；
- FIN_WAIT1：主动关闭(active close)端应用程序调用close，于是其TCP发出FIN请求主动关闭连接，之后进入FIN_WAIT1状态， 等待远程TCP的连接中断请求，或先前的连接中断请求的确认
- CLOSE_WAIT：被动关闭(passive close)端TCP接到FIN后，就发出ACK以回应FIN请求(它的接收也作为文件结束符传递给上层应用程序)，并进入CLOSE_WAIT， 等待从本地用户发来的连接中断请求；
- FIN_WAIT2：主动关闭端接到ACK后，就进入了 FIN-WAIT-2，从远程TCP等待连接中断请求；
- LAST_ACK：被动关闭端一段时间后，接收到文件结束符的应用程 序将调用CLOSE关闭连接，这导致它的TCP也发送一个 FIN,等待对方的ACK.就进入了LAST-ACK，等待原来发向远程TCP的连接中断请求的确认；
- TIME_WAIT:在主动关闭端接收到FIN后，TCP 就发送ACK包，并进入TIME-WAIT状态，等待足够的时间以确保远程TCP接收到连接中断请求的确认；
- CLOSING: 比较少见，等待远程TCP对连接中断的确认；
- CLOSED: 被动关闭端在接受到ACK包后，就进入了closed的状态，连接结束，没有任何连接状态；
- UNKNOWN：未知的Socket状态；

## TCP头部选项
TCP头部的最后一个选项字段(options)是可变长的可选信息。这部分最多包含40字节。典型的TCP头部选项结构如图所示.

```sh
--------------------------------------------------
| Kind(1 字节) | Length（1 字节） | info(n 字节) |
--------------------------------------------------
```
选项的第一个字段kind说明选项的类型。冇的TCP选项没有后面两个字段，仅包含1 字节的kind字段。
第二个字段length（如果有的话）指定该选项的总长度，该长度包括kind 字段和length字段占据的2字节。
第三个字段info （如果有的话）是选项的具体信息。常见 的TCP选项冇7种，如图所示。
```sh
kind=O	
kind=1							
kind=2	lcngth=4	最大segment长度（2字节）		
kind=3	length=3	移位数（1字节）		
kind=4	lcngth=2						
kind=5	length=N*8+2	第1块左边沿	第1块右边沿	•••	第N块左边沿	第N块右边沿
kind=8	lcngth=1O	时间戮值(4字节）	时间戮回显应答（4字节）
```
- kind=0是选项表结束选项。
- kind=1是空操作（nop）选项，没有特殊含义，一般用于将TCP选项的总长度填充为4 字节的整数倍。
- kind=2是最大报文段长度选项。TCP连接初始化时，通信双方使用该选项来协商最大报文段长度（Max Segment Size, MSS）。TCP模块通常将MSS设置为（MTU-40）字节（减掉的这40字节包括20字节的TCP头部和20字节的IP头部）。这样携带TCP报文段的IP 数据报的长度就不会超过MTU（假设TCP头部和IP头部都不包含选项字段，并且这也是一般情况），从而避免本机发生IP分片。对以太网而言，MSS值是1460 （1500-40）字节。
- kind=3是窗口扩大因子选项。TCP连接初始化时，通信双方使用该选项来协商接收通告窗口的扩大因子。在TCP的头部中，接收通告窗口大小是用16位表示的，故最大为65 535 字节，但实际上TCP模块允许的接收通告窗口大小远不止这个数（为了提高TCP通信的吞吐信）。窗口扩大因子解决了这个问题。假设TCP头部中的接收通告窗口大小是N,窗口扩大因子（移位数）是M,那么TCP报文段的实际接收通告窗口大小是N左移M位。注意，M的取值范围是0〜14。我们可以通过修改/proc/sys/net/ipv4/tcp_window scaling内核变量来启用或关闭窗口扩大因子选项。 和MSS选项一样，窗口扩大因子选项只能出现在同步报文段中，否则将被忽略。但同步报文段本身不执行窗口扩大操作，即同步报文段头部的接收通告窗口大小就是该TCP报文段的实际接收通告窗口大小。当连接建立好之后，每个数据传输方向的窗口扩大因子就固定不变了。
- kind=4是选择性确认（Selective Acknowledgment, SACK）选项。TCP通信时，如果某个TCP报文段丢失，则TCP模块会重传最后被确认的TCP报文段后续的所有报文段，这样 原先已经正确传输的TCP报文段也可能重复发送，从而降低了TCP性能。SACK技术正是为改善这种情况而产生的，它使TCP模块只重新发送丢失的TCP报文段，不用发送所有未被确认的TCP报文段。选择性确认选项用在连接初始化时，表示是否支持SACK技术。我们可以通过修改/proc/sys/nct/ipv4/tcp_sack内核变量来启用或关闭选择性确认选项。
- kind=5是SACK实际工作的选项。该选项的参数吿诉发送方本端已经收到并缓存的不连续的数据块，从而让发送端可以据此检査并重发丢失的数据块。每个块边沿（edge of block）参数包含一个4字节的序号。其中块左边沿表示不连续块的第一个数据的序号，而块右边沿则表示不连续块的最后一个数据的序号的下一个序号。这样一对参数（块左边沿和块右边沿）之冋的数据是没有收到的。因为一个块信息占用8字节，所以TCP头部选项中实际上最多可以包含4个这样的不连续数据块（考虑选项类型和长度占用的2字节）。
- kind=8是时间戳选项。该选项提供了较为准确的计算通信双方之间的回路时间（Round Trip Time, RTT）的方法，从而为TCP流域控制提供重要信息。我们可以通过修改/proc/sys/net/ipv4/tcp_timestamps内核变量来启用或关闭时间戳选项。

### 使用tcpdump观察TCP头部信息
```sh
19:36:14.403712 IP 36.110.206.45.33965 > VM-12-3-ubuntu.8888: Flags [S], seq 2066908838, win 65535, options [mss 1160,nop,wscale 6,nop,nop,TS val 723456688 ecr 0,sackOK,eol], length 0
```

tepdump输出Flags[S],表示该TCP报文段包含SYN标志，因此它是一个同步报文段。 
win是接收通告窗口的大小.因为这是一个同步报文段，所以win偵反映的是实际的接收通告窗口大小.
options是TCP选项，其具体内容列在方括号中.
	mss是发送端（客户端）通告的最大报文段长度。sackOK表示发送端支持并同意使用SACK选项。 TS val是发送端的时间戳。ecr是时间戳回显应答。因为这是一次TCP通信的第一个TCP报文段，所以它针对对方的时间戳的应答为0 （尚未收到对方的时间戳）。紧接着的nop是一个空操作选项。wscale指出发送端使用的窗口扩大因子为6.








